export const EARLY_COMPLETENESS_FUNCTION =
  '//Example of function implementation\nparameters.progress(50);\nfunction getOrgUnitDataSetCompleteness(ds,ou,pe){\n\treturn new Promise(function(resolve, reject) {\n\t\t$.ajax({\n\t\t\turl: "../../../api/26/completeDataSetRegistrations.json?dataSet=" + ds.join("&dataSet=") + "&orgUnit=" + ou + "&period=" + pe.join("&period=")+"&children=true",\n\t\t\ttype: "GET",\n\t\t\tsuccess: function(completeness) {\n\t\t\t\t  resolve(completeness.completeDataSetRegistrations);\n\t\t\t},\n\t\t\terror:function(error){\n\t\t\t\t  parameters.error(error);\n\t\t\t}\n\t\t});\n\t} );\n}\nfunction getDataSetCompleteness(ds,ou,pe){\n\treturn new Promise(function(resolve, reject) {\n\t\tvar promises = [];\n\t\t\n\t    ou.forEach(function(o){\n\t        promises.push(getOrgUnitDataSetCompleteness(ds,o,pe));\n\t    })\n\t    Promise.all(promises).then(function(results){\n\t\t\tconsole.log("Results:",results);\n\t\t\tvar completeness = [];\n\t\t\tresults.forEach(function(result){\n\t\t\t    if(result)\n\t\t\t\tresult.forEach(function(completeDataSetRegistration){\n\t\t\t\t\tvar isFound = false;\n\t\t\t\t\tcompleteness.forEach(function(addedCompleteness){\n\t\t\t\t\t\tif(addedCompleteness.period == completeDataSetRegistration.period && \n\t\t\t\t\t\taddedCompleteness.dataSet == completeDataSetRegistration.dataSet &&\n\t\t\t\t\t\taddedCompleteness.organisationUnit == completeDataSetRegistration.organisationUnit){\n\t\t\t\t\t\t\tisFound = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\tif(!isFound){\n\t\t\t\t\t\tcompleteness.push(completeDataSetRegistration);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t\tresolve(completeness);\n\t\t})\n\t} );\n}\n\nfunction getDataSets(dataSetIds){\n\treturn new Promise(function(resolve, reject) {\n\t\t$.ajax({\n\t\t\turl: "../../../api/26/dataSets.json?fields=organisationUnits[id,path]&filter=id:in:[" + dataSetIds.join(",") +"]",\n\t\t\ttype: "GET",\n\t\t\tsuccess: function(dataSetResults) {\n\t\t\t\t  resolve(dataSetResults.dataSets);\n\t\t\t},\n\t\t\terror:function(error){\n\t\t\t\t  parameters.error(error);\n\t\t\t}\n\t\t});\n\t} );\n}\nfunction getAnalyticsObject(){\n\treturn new Promise(function(resolve, reject) {\n\t\t$.ajax({\n\t\t\turl: "../../../api/25/analytics.json?dimension=pe:" + parameters.pe + "&dimension=ou:" + parameters.ou + "&displayProperty=NAME&skipData=true",\n\t\t\ttype: "GET",\n\t\t\tsuccess: function(results) {\n\t\t\t\tresults.headers = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t  "name": "dx",\n\t\t\t\t\t\t\t\t  "column": "Data",\n\t\t\t\t\t\t\t\t  "valueType": "TEXT",\n\t\t\t\t\t\t\t\t  "type": "java.lang.String",\n\t\t\t\t\t\t\t\t  "hidden": false,\n\t\t\t\t\t\t\t\t  "meta": true\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t  "name": "pe",\n\t\t\t\t\t\t\t\t  "column": "Period",\n\t\t\t\t\t\t\t\t  "valueType": "TEXT",\n\t\t\t\t\t\t\t\t  "type": "java.lang.String",\n\t\t\t\t\t\t\t\t  "hidden": false,\n\t\t\t\t\t\t\t\t  "meta": true\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t  "name": "ou",\n\t\t\t\t\t\t\t\t  "column": "Organisation unit",\n\t\t\t\t\t\t\t\t  "valueType": "TEXT",\n\t\t\t\t\t\t\t\t  "type": "java.lang.String",\n\t\t\t\t\t\t\t\t  "hidden": false,\n\t\t\t\t\t\t\t\t  "meta": true\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t  "name": "value",\n\t\t\t\t\t\t\t\t  "column": "Value",\n\t\t\t\t\t\t\t\t  "valueType": "NUMBER",\n\t\t\t\t\t\t\t\t  "type": "java.lang.Double",\n\t\t\t\t\t\t\t\t  "hidden": false,\n\t\t\t\t\t\t\t\t  "meta": false\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t  ]\n\t\t\t\tresults.metaData.names[parameters.rule.id] = parameters.rule.name;\n\t\t\t\tresults.metaData.dx = [parameters.rule.id];\n\t\t\t\tresolve(results);\n\t\t\t},\n\t\t\terror:function(error){\n\t\t\t\treject(error);\n\t\t\t}\n\t\t});\n\t} );\n}\nfunction getOrgUnitHierarchy(){\n\treturn new Promise(function(resolve, reject) {\n\t\t$.ajax({\n\t\t\turl: "../../../api/25/analytics.json?dimension=pe:" + parameters.pe + "&dimension=ou:" + parameters.ou + ";LEVEL-6&displayProperty=NAME&skipData=true",\n\t\t\ttype: "GET",\n\t\t\tsuccess: function(results) {\n\t\t\t\tresolve(results.metaData);\n\t\t\t},\n\t\t\terror:function(error){\n\t\t\t\treject(error);\n\t\t\t}\n\t\t});\n\t} );\n}\n\nvar dataSetIds = ["s4029egvhCv","z2slLbjn7PM"];\ngetAnalyticsObject().then(function(results){\n\tgetDataSets(dataSetIds).then(function(dataSets){\n\t\tgetDataSetCompleteness(dataSetIds,results.metaData.ou,results.metaData.pe).then(function(completeness){\n\t\t\tif(completeness)\n\t\t\tresults.metaData.ou.forEach(function(ou){\n\t\t\t\tresults.metaData.pe.forEach(function(pe){\n\t\t\t\t\tvar denominator = 0;\n\t\t\t\t\tvar numerator = 0;\n\t\t\t\t\tvar dataSetMapper = {};\n\t\t\t\t\tdataSets.forEach(function(dataSet){\n\t\t\t\t\t\tdataSet.organisationUnits.forEach(function(orgUnit){\n\t\t\t\t\t\t\tcompleteness.forEach(function(completenessData){\n\t\t\t\t\t\t\t\tif(completenessData.period == pe && completenessData.organisationUnit == orgUnit.id && orgUnit.path.indexOf(ou) > -1){\n\t\t\t\t\t\t\t\t\tif(!dataSetMapper[orgUnit.id]){\n\t\t\t\t\t\t\t\t\t\tdataSetMapper[orgUnit.id] = {};\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tdataSetMapper[orgUnit.id][completenessData.dataSet] = completenessData.date;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t})\n\t\t\t\t\t})\n\t\t\t\t\tObject.keys(dataSetMapper).forEach(function(key){\n\t\t\t\t\t\tif(dataSetMapper[key][dataSetIds[0]] && dataSetMapper[key][dataSetIds[1]]){\n\t\t\t\t\t\t\tnumerator +=Math.abs(daysBetween(new Date(dataSetMapper[key][dataSetIds[0]]),new Date(dataSetMapper[key][dataSetIds[1]])));\n\t\t\t\t\t\t\tdenominator++;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\tif(denominator != 0){\n\t\t\t\t\t\tresults.rows.push([parameters.rule.id,pe,ou,(numerator/denominator).toFixed(2)]);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t\tresults.height = results.rows.length;\n\t\t\tresults.width = results.headers.length;\n\t\t\tconsole.log("Analytics Results:",results);\n\t\t\tparameters.success(results);\n\t\t})\n\t})\n})\nfunction daysBetween( date1, date2 ) {   //Get 1 day in milliseconds   \n\tvar one_day=1000*60*60*24;    // Convert both dates to milliseconds\n\tvar date1_ms = date1.getTime();   \n\tvar date2_ms = date2.getTime();    // Calculate the difference in milliseconds  \n\tvar difference_ms = date2_ms - date1_ms;        // Convert back to days and return   \n\treturn Math.round(difference_ms/one_day); \n } \n';
